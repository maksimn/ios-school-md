# Учебные задачи

### ЗАДАЧА

[Начало работы над проектом пинг-понга - Л1 01:17:00 до конца]

Надо было сделать пинг-понг.

Нам нужно как-то прикрутить в проект работу с background потоком. Нам нужно вести отсчёт времени матча - чтобы знать, сколько времени прошло.

Тогда нужно на бэк-потоке запустить таймер, а обновлять его уже на главном потоке. Нам понадобится какой-то объект label, который будет показывать время. Нам нужен таймер, который будет запускаться в бэкграунде. И нужно, чтобы его fire срабатывал на главном потоке.

1) создаем label в initGameField. Начальное значение - 00:00.

2) больше таймеров богу таймеров.

Хотите через `NSThread` - давайте через `NSThread`. Создали поток, запустили. В нем countTime.

Таймер создается, и у него также есть селектор, который будет вызываться каждую итерацию времени.

Инт-переменная, увеличивать ее на 1 в этой функции, затем переводить в String.

`UILabel` надо обновлять в главном потоке. Для этого способ, который мы знаем - `performSelectorToMainThread`. Когда уже обновили `count`. Cелектор - значит создать ещё какой-то метод.

Хочется передать в метод наш count как withObject.

Label в property.

Для передачи строки - `NSString stringWithFormat`. Сначала передается формат.

Ему не нравится, что вы создали countTimer, вы его запустите, но нигде не за invalidate'ите и не занилите (чтобы не было retain-циклов). 

Запустили... что-то пошло не так...

Подсказка: таймер, run loop и потоки как-то связаны. Здесь возникает некая проблемка.

__Первое мини-дз__: разобраться, почему таймер не запускается на background thread и как это поправить. Ключевые слова: runLoop

Жду ответов как это произошло, почему (про "почему" это должно быть как минимум несколько предложений), как это исправить.

Просто ответ "run loop" не проходит. Как run loop связан с таймером, как поправить эту историю.

### Решение

Привет, Алексей! Отправляю решение мини-ДЗ про пингпонг и потоки с таймерами.

Почему таймер не запускается на фоновом потоке и как это исправить. Дело в том, что при создании фонового потока с ним создаётся новый Run Loop, отличный от главного Run Loop приложения. Run loop - это механизм ОС для обработки событий от окна приложения, портов, соединений и таймеров. Именно с этим новым Run loop и связаны события того таймера, который преназначен для отсчёта времени игры. А интерфейс приложения можно обновлять только через главный UI-поток и события, связанные с run loop этого UI-потока. Так что через таймер, созданный в фоновом потоке, это сделать не удаётся.

Способы исправить - вариант 1) запустить таймер для отсчёта времени так же, как и таймер для обсчёта игры в пингпонг - в главном потоке.

Вариант 2) созданный в фоновом потоке таймер добавить в Run loop главного потока через метод `NSRunLoop addTimer`, предварительно получив ссылку на этот главный Run loop:

```objectivec
self.counterTimer = [NSTimer timerWithTimeInterval:1.0 target:self selector:@selector(counterTimerCallback) userInfo:nil repeats:YES];
[self.mainRunLoop addTimer:self.counterTimer forMode:NSDefaultRunLoopMode];
```
