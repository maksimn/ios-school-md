# JS in Browser. Клиентский JavaScript.

## 1.0. Основы

Объект Window представляет окно веб-браузера или фрейм, и Вы можете обратиться к нему через идентификатор window. Являет глобальным объектом для клиентского JS.

1) Свойство location ссылается на объект Location, который задаёт URL изображенного в данный момент окна, и позволяет сценарию загрузить новый URL в окно.
2) Метод alert() отображает диалоговое окно.
3) Метод setTimeout() регистрирует функцию, вызваемую через заданный интервал времени.
4) Свойство document возвращает объект документа в окне.

### 1.1. JS в веб-документах

Программа на JS может манипулировать контентом документа (через объекты документа и элементов), управлять представлением документа (через программирование стилей CSS и классов), задавать поведение элементов документа (через обработчики событий). Это называлось DHTML.

Основная же задача JS – улучшать user's experience, сделать для него проще процесс получения и передачи информации.

### 1.2. JS в веб-приложениях

Веб-приложения используют не только DHTML, но и возможности работы с сетями, хранения данных и графики. Пример – AJAX.

## 2. Встраивание JS в HTML

Есть 4 способа встроить JS в документ HTML:

* Встроить между тегами `<script>` и `</script>`
* Из внешнего файла сценария через тег `<script>` с атрибутом src
* Через обработчик события в HTML
* В URL, использующем специальный протокол javascript:

## 3. Исполнение JS программ 

### 0) Основы

Исполнение программы на JS происходит в 2 фазы. 
На первой фазе загружается содержимое документа и код элементов `<script>` (как встроенных, так и внешних сценариев) выполняется. Сценарии в основном, но не всегда, выполняются в порядке, в котором они появляются в документе.

Вторая фаза – асинхронная и событийная. Браузер асинхронно исполняет обработчики происходящих событий. 

Одно из первых событий в работе программы – это событие загрузки документа.

И базовый, и клиентский JS имеют однопоточную модель исполнения. Сценарии и обработчики событий исполняются по одному во времени без конкуренции (или должны казаться таковыми).

### 1) Синхронные, асинхронные и отложенные сценарии

Когда парсер HTML встречает элемент `<script>`, он должен по умолчанию выполнить данный сценарий до того, как он возобновит парсинг и отображение документа. Это не является большой проблемой для встроенных сценариев, но если исходный код сценария – внешний файл, это означает, что часть документа, идущая после сценария, не будет показана, пока не будет загружен и исполнен сценарий.

Такое синхронное или блокирующее исполнение сценариев имеется лишь по умолчанию. Тэг `<script>` может иметь атрибуты defer и async, которые выполняют по-другому.

Атрибуты defer и async говорят браузеру, что связанный с ними сценарий не будет генерировать содержимое документа, и что поэтому браузер может продолжить парсинг документа и его отображение пока загружается этот сценарий.

defer откладывает выполнение браузером сценария, пока документ не будет загружен и проанализирован и готов к манипулированию им. async говорит браузеру, что сценарий должен выполняться как можно быстрее, но при этом не блокируется парсинг документа во время загрузки сценария.

Загружать и исполнять сценарии асинхронно можно даже в браузерах, которые не поддерживают атрибут async. Для этого используем функцию loadasync() [пример].

### 2) Событийный JavaScript

Программы, в которых есть обработчики событий. Эти функции исполняются асинхронно после наступления событий, для которых они были зарегистрированы.

### 3) Модель потоков JavaScript на клиенте

Базовый язык JavaScript не содержит какой-либо механизм работы с потоками, и клиентский по своему обычаю тоже. HTML5 определяет "WebWorkers", которые служат в качестве фонового потока, но клиентский JS ведёт себя как строго однопоточный.

### 4) Временной ход клиентского JS

Выполнение JS программы подробно:

1. Браузер создаёт объект документа и начнает парсинг веб-страницы, добавление объектов элементов и текстовых узлов в документ в ходе парсинга. Свойство document.readyStateproperty имеет значение “loading” на этом этапе.
…
8. …


## 4. Совместимость

Вопросы совместимости клиентского JavaScript для разных платформ разделяются на 3 общие категории:
Эволюция – новые стандартные возможности могут отсутствовать в старых браузерах и быть в новых.
Отсутствие реализации – в некоторых браузерах реализации некоторых функций отсутствуют.
Баги – могут быть баги в реализации client-side JavaScript API.

Самый простой и прямолинейный способ решения проблемы совместимости – использовать только те возможности, которые поддерживаются универсально всеми системами. Но есть и другие, менее пассивные возможности.

### 4.1. Библиотеки совместимости

Пример:

excanvas.js – библиотека, позволяющая работать в Internet Explorer так, как будто он поддерживает `<canvas>`.

### 4.2. Градационная поддержка браузеров

- это техника тестирования и QA, которая привносит некоторую ясность в противном случае неуправляемую пролиферацию вариантов поставщиков/версий/ОС.

Коротко говоря, она включает выбор браузеров "A-класса", которые получают полную поддержку, и тестирование и идентифицирование браузеров "С-класса", которые не являются достаточно мощными. Браузеры С-уровня обслуживают минимальные HTML-версии страниц, которые не требуют JavaScript или CSS. Браузеры не-А и не-С класса называются Х-классом. Предполагается, что они способны обслуживать полнофункциональные веб-страницы, но они не поддерживаются и не тестируются официально.

### 4.3. Тестирование функций

Пример:

```js
if (element.addEventListener) { 
   …
}
else if (element.attachEvent) { 
   …
}
else { 
   …
}
```

### 4.4. Quirks-режим и стандартный режим

Стандартный режим – режим отображения HTML-документа, опирающийся на CSS-стандарты.
Quirks-режим – нестандартный режим отображения, идущий от старых IE. 

Представление о возможности таких режимов стало стандартным и вошло в спецификацию HTML5.

Клиентскому JS иногда нужно знать, в каком режиме отображается документ. Чтобы выполнить проверку режима отображения, проверьте свойство document.compatMode.

### 4.5. Тестирование браузера

### 4.6. Условные комментарии в IE

Условные комментарии для HMTL

```
<!--[if IE]><script src="excanvas.js"></script><![endif]-->
```

Есть условное комментирование и для JS кода.

## 5. Accessibility

## 6. Безопасность

### 6.1. Что JavaScript не может делать?

### 6.2. Политика ограничения домена

The  same-origin policy is a sweeping security restriction on what web content JavaScript code  can  interact  with.  It  typically  comes  into  play  when  a  web  page  includes `<iframe>` elements or opens other browser windows. In this case, the same-origin policy governs the interactions of JavaScript code in one window or frame with the content of  other  windows  and  frames.  Specifically,  a  script  can  read  only  the  properties  of windows and documents that have the same origin as the document that contains the script.

### 6.3. Сценарии плагинов и элементов ActiveX

### 6.4. Кросс-сайтные сценарии

Кросс-сайтные сценарии (или XSS) – термин для некоторой категории проблем безопасности, в которых атакующий производит инъекцию HTML-тэгов и сценариев на атакуемом вебсайте.

### 6.5. Denial-of-service атаки

Вредоносный JS-код может перегружать и подвешивать систему, например, с помощью бесконечных циклов.

## 7. Фреймворки для клиентского JS

Аннотированы Prototype, Dojo, YUI, Closure, GWT.
